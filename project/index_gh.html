<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾¹å¡ç›‘æµ‹æ•°æ®å®æ—¶å±•ç¤º</title>
    <!-- å¼•å…¥ECharts CDNï¼ˆæ— éœ€æœ¬åœ°å®‰è£…ï¼Œç›´æ¥ä½¿ç”¨ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }
        body {
            padding: 20px;
            background-color: #f5f7fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-box {
            width: 100%;
            height: 400px;
            margin: 20px 0;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 10px;
        }
        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 12px 15px;
            text-align: center;
            border: 1px solid #e1e8ed;
        }
        th {
            background-color: #3498db;
            color: white;
            font-weight: normal;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #e3f2fd;
        }
        /* çŠ¶æ€æç¤º */
        .status {
            margin-bottom: 10px;
            color: #666;
            font-size: 14px;
        }
        .error {
            color: #e74c3c;
        }
        .success {
            color: #27ae60;
        }
        /* æ•°æ®åˆ·æ–°æç¤º */
        .refresh-tip {
            margin-top: 10px;
            font-size: 12px;
            color: #999;
            text-align: right;
        }
        /* ç­›é€‰æ§ä»¶æ ·å¼ */
        .filter-box {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-box label {
            color: #666;
            font-size: 14px;
        }
        .filter-box select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        /* é…ç½®æç¤ºæ ·å¼ */
        .config-tip {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px 15px;
            margin-bottom: 15px;
            color: #856404;
            font-size: 13px;
        }
        .config-tip a {
            color: #0066cc;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è¾¹å¡ç›‘æµ‹ä¼ æ„Ÿå™¨å®æ—¶æ•°æ®</h1>
        
        <!-- GitHub Pages é…ç½®æç¤º -->
        <div class="config-tip" id="config-tip" style="display: none;">
            âš ï¸ è¯·å…ˆä¿®æ”¹ä»£ç ä¸­çš„ <strong>API_BASE_URL</strong> ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€
        </div>
        
        <div class="status" id="status">ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</div>
        
        <!-- EChartså›¾è¡¨å®¹å™¨ -->
        <div class="chart-box" id="sensor-chart"></div>
        
        <!-- è®¾å¤‡ç­›é€‰æ§ä»¶ -->
        <div class="filter-box">
            <label for="device-filter">é€‰æ‹©è®¾å¤‡ï¼š</label>
            <select id="device-filter">
                <option value="all">æ‰€æœ‰è®¾å¤‡</option>
                <!-- è®¾å¤‡é€‰é¡¹ä¼šé€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </select>
            <label for="value-type">æŸ¥çœ‹ä½ç§»ï¼š</label>
            <select id="value-type">
                <option value="both">X+Yä½ç§»</option>
                <option value="x">ä»…Xä½ç§»</option>
                <option value="y">ä»…Yä½ç§»</option>
            </select>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <table>
            <thead>
                <tr>
                    <th>åºå·ï¼ˆIDï¼‰</th>
                    <th>è®¾å¤‡ç¼–å·</th>
                    <th>Xæ–¹å‘ä½ç§» (m)</th>
                    <th>Yæ–¹å‘ä½ç§» (m)</th>
                    <th>é‡‡é›†æ—¶é—´</th>
                </tr>
            </thead>
            <tbody id="data-table">
                <!-- æ•°æ®ä¼šé€šè¿‡JSåŠ¨æ€å¡«å…… -->
            </tbody>
        </table>
        <div class="refresh-tip" id="refresh-time">æœ€ååˆ·æ–°æ—¶é—´ï¼š--</div>
    </div>

    <script>
        // ===================== é…ç½®é¡¹ =====================
        // ä¿®æ”¹ä¸ºä½ çš„æœåŠ¡å™¨åœ°å€ï¼ˆåŒ…å«ç«¯å£å·ï¼‰
        // ç¤ºä¾‹ï¼šconst API_BASE_URL = 'http://120.26.23.53:5000';
        const API_BASE_URL = 'http://120.26.23.53:5000';
        // =================================================
        
        // æ£€æŸ¥é…ç½®æ˜¯å¦å·²ä¿®æ”¹
        if (API_BASE_URL === 'http://120.26.23.53:5000') {
            document.getElementById('config-tip').style.display = 'block';
            document.getElementById('status').innerHTML = 'âš ï¸ è¯·å…ˆä¿®æ”¹ API_BASE_URL é…ç½®';
            document.getElementById('status').className = 'status error';
        }
        
        // åˆå§‹åŒ–EChartså®ä¾‹
        const chartDom = document.getElementById('sensor-chart');
        const myChart = echarts.init(chartDom);
        let allSensorData = []; // å­˜å‚¨æ‰€æœ‰åŸå§‹æ•°æ®
        let deviceList = [];    // å­˜å‚¨è®¾å¤‡åˆ—è¡¨

        // æ ¼å¼åŒ–EChartsæ•°æ®çš„å‡½æ•°
        function formatChartData(filterDevice, valueType) {
            // ç­›é€‰æ•°æ®ï¼šæŒ‰è®¾å¤‡è¿‡æ»¤
            let filteredData = allSensorData;
            if (filterDevice !== 'all') {
                filteredData = allSensorData.filter(item => item.device_id === filterDevice);
            }
            // æŒ‰æ—¶é—´å‡åºæ’åºï¼ˆæŠ˜çº¿å›¾éœ€è¦æ—¶é—´é¡ºåºï¼‰
            filteredData.sort((a, b) => new Date(a.monitor_time) - new Date(b.monitor_time));

            // æå–æ—¶é—´è½´ï¼ˆxè½´ï¼‰
            const xAxisData = filteredData.map(item => item.monitor_time);
            
            // æ„å»ºç³»åˆ—æ•°æ®ï¼ˆyè½´ï¼‰
            const series = [];
            // å¤„ç†Xä½ç§»
            if (valueType === 'both' || valueType === 'x') {
                series.push({
                    name: 'Xæ–¹å‘ä½ç§» (m)',
                    type: 'line',
                    data: filteredData.map(item => item.value_x),
                    smooth: true, // å¹³æ»‘æŠ˜çº¿
                    lineStyle: { width: 2 },
                    itemStyle: { color: '#3498db' },
                    tooltip: { valueFormatter: (val) => `${val} m` }
                });
            }
            // å¤„ç†Yä½ç§»
            if (valueType === 'both' || valueType === 'y') {
                series.push({
                    name: 'Yæ–¹å‘ä½ç§» (m)',
                    type: 'line',
                    data: filteredData.map(item => item.value_y),
                    smooth: true,
                    lineStyle: { width: 2 },
                    itemStyle: { color: '#e74c3c' },
                    tooltip: { valueFormatter: (val) => `${val} m` }
                });
            }

            // EChartsé…ç½®é¡¹
            const option = {
                title: {
                    text: `è®¾å¤‡${filterDevice === 'all' ? 'æ±‡æ€»' : filterDevice}ä½ç§»è¶‹åŠ¿`,
                    left: 'center',
                    textStyle: { fontSize: 16, color: '#2c3e50' }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                        let res = params[0].name;
                        params.forEach(param => {
                            res += `<br/>${param.seriesName}ï¼š${param.value} m`;
                        });
                        return res;
                    }
                },
                legend: {
                    data: ['Xæ–¹å‘ä½ç§» (m)', 'Yæ–¹å‘ä½ç§» (m)'],
                    top: 30
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: xAxisData,
                    axisLabel: {
                        rotate: 45, // æ—¶é—´æ ‡ç­¾æ—‹è½¬45åº¦ï¼Œé¿å…é‡å 
                        fontSize: 12
                    },
                    name: 'é‡‡é›†æ—¶é—´',
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    type: 'value',
                    name: 'ä½ç§»å€¼ (m)',
                    axisLabel: {
                        formatter: '{value} m'
                    }
                },
                series: series
            };
            return option;
        }

        // åˆ·æ–°æ•°æ®çš„å‡½æ•°ï¼ˆåŒ…å«è¡¨æ ¼+å›¾è¡¨ï¼‰
        function fetchSensorData() {
            // å¦‚æœé…ç½®æœªä¿®æ”¹ï¼Œä¸å‘é€è¯·æ±‚
            if (API_BASE_URL === 'http://your_server_ip:5000') {
                return;
            }
            
            fetch(`${API_BASE_URL}/api/sensor-data`)
                .then(response => response.json())
                .then(res => {
                    const statusEl = document.getElementById('status');
                    const tableEl = document.getElementById('data-table');
                    const refreshTimeEl = document.getElementById('refresh-time');
                    const deviceFilter = document.getElementById('device-filter');
                    const valueType = document.getElementById('value-type');
                    
                    // æ›´æ–°æœ€ååˆ·æ–°æ—¶é—´
                    const now = new Date().toLocaleString('zh-CN');
                    refreshTimeEl.innerText = `æœ€ååˆ·æ–°æ—¶é—´ï¼š${now}`;

                    if (res.code === 200 && res.data.length > 0) {
                        // æˆåŠŸè·å–æ•°æ®
                        statusEl.className = 'status success';
                        statusEl.innerText = `âœ… æ•°æ®åŠ è½½æˆåŠŸï¼ˆå…±${res.data.length}æ¡ï¼‰`;
                        allSensorData = res.data; // ä¿å­˜åŸå§‹æ•°æ®
                        
                        // 1. æ›´æ–°è¡¨æ ¼æ•°æ®
                        tableEl.innerHTML = '';
                        res.data.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${item.id}</td>
                                <td>${item.device_id}</td>
                                <td>${item.value_x}</td>
                                <td>${item.value_y}</td>
                                <td>${item.monitor_time}</td>
                            `;
                            tableEl.appendChild(tr);
                        });

                        // 2. æ›´æ–°è®¾å¤‡ç­›é€‰ä¸‹æ‹‰æ¡†ï¼ˆå»é‡ï¼‰
                        deviceList = [...new Set(res.data.map(item => item.device_id))];
                        // æ¸…ç©ºåŸæœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰è®¾å¤‡"ï¼‰
                        deviceFilter.innerHTML = '<option value="all">æ‰€æœ‰è®¾å¤‡</option>';
                        deviceList.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device;
                            option.textContent = device;
                            deviceFilter.appendChild(option);
                        });

                        // 3. æ›´æ–°EChartså›¾è¡¨
                        const chartOption = formatChartData(
                            deviceFilter.value,
                            valueType.value
                        );
                        myChart.setOption(chartOption);

                    } else {
                        // æ— æ•°æ®æˆ–å¤±è´¥
                        statusEl.className = 'status error';
                        statusEl.innerText = `âŒ ${res.msg}ï¼ˆæš‚æ— æ•°æ®ï¼‰`;
                        tableEl.innerHTML = '<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>';
                        // æ¸…ç©ºå›¾è¡¨
                        myChart.setOption({ series: [] });
                    }
                })
                .catch(error => {
                    const statusEl = document.getElementById('status');
                    statusEl.className = 'status error';
                    statusEl.innerText = `âŒ ç½‘ç»œ/æœåŠ¡å¼‚å¸¸ï¼š${error.message}`;
                    // æ¸…ç©ºå›¾è¡¨
                    myChart.setOption({ series: [] });
                });
        }

        // ç›‘å¬ç­›é€‰æ§ä»¶å˜åŒ–ï¼Œå®æ—¶æ›´æ–°å›¾è¡¨
        document.getElementById('device-filter').addEventListener('change', () => {
            const chartOption = formatChartData(
                document.getElementById('device-filter').value,
                document.getElementById('value-type').value
            );
            myChart.setOption(chartOption);
        });
        document.getElementById('value-type').addEventListener('change', () => {
            const chartOption = formatChartData(
                document.getElementById('device-filter').value,
                document.getElementById('value-type').value
            );
            myChart.setOption(chartOption);
        });

        // é¡µé¢åŠ è½½æ—¶ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
        fetchSensorData();

        // æ¯éš”1ç§’è‡ªåŠ¨åˆ·æ–°ï¼ˆå’Œæ•°æ®å†™å…¥é¢‘ç‡åŒæ­¥ï¼‰
        setInterval(fetchSensorData, 1000);

        // çª—å£å¤§å°å˜åŒ–æ—¶ï¼Œé‡æ–°è°ƒæ•´å›¾è¡¨å¤§å°
        window.addEventListener('resize', () => {
            myChart.resize();
        });
    </script>
</body>
</html>
