<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç‚¹åæ ‡è®¡ç®—å·¥å…· (Webç‰ˆ)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.5rem; }
        
        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 40px; text-align: center; margin: 20px 0; transition: all 0.3s; cursor: pointer; background: #fafafa; }
        .upload-area:hover, .upload-area.dragover { border-color: var(--accent-color); background: #eef7fd; }
        .icon { font-size: 48px; color: #ccc; margin-bottom: 10px; display: block; }
        
        /* æŒ‰é’®ä¸çŠ¶æ€ */
        .btn { background-color: var(--accent-color); color: white; padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: background 0.2s; display: inline-block; margin-top: 10px; }
        .btn:hover { background-color: #2980b9; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .status-box { margin-top: 20px; padding: 15px; border-radius: 6px; display: none; }
        .status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* è¡¨æ ¼é¢„è§ˆ */
        .table-container { margin-top: 25px; overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; white-space: nowrap; }
        th { background-color: #f8f9fa; position: sticky; top: 0; z-index: 10; font-weight: 600; }
        .outlier-row { background-color: #fff3cd; } /* å¼‚å¸¸è¡Œé«˜äº® */
        
        .hidden-input { display: none; }
        .summary { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1>å·¥ç‚¹è®¾å¤‡åæ ‡è®¡ç®—ä¸åˆ†æç³»ç»Ÿ</h1>
    <p class="summary">åŸºäºæµè§ˆå™¨æœ¬åœ°è®¡ç®—ï¼Œæ•°æ®ä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚æ”¯æŒ .xlsx, .xls, .csv</p>

    <div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
        <span class="icon">ğŸ“‚</span>
        <p>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ æˆ– å°†æ–‡ä»¶æ‹–æ‹½è‡³æ­¤</p>
        <p style="font-size: 0.85em; color: #999;">å¿…éœ€åˆ—ï¼šæ‰€å±å·¥ç‚¹, ç»åº¦, çº¬åº¦, è®¾å¤‡ç¼–ç <br>(å¯é€‰: æ‰€å±é¡¹ç›®, è®¾å¤‡åç§°)</p>
        <input type="file" id="fileInput" class="hidden-input" accept=".xlsx, .xls, .csv">
    </div>

    <div id="statusBox" class="status-box"></div>

    <div id="resultArea" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin:0;">å¤„ç†ç»“æœé¢„è§ˆ</h3>
            <button class="btn" onclick="exportToExcel()">ğŸ“¥ ä¸‹è½½è®¡ç®—ç»“æœ</button>
        </div>
        <div class="table-container">
            <table id="previewTable">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // === å…¨å±€å˜é‡ ===
    let globalProcessedData = [];
    const R = 6371000; // åœ°çƒåŠå¾„

    // === äº‹ä»¶ç›‘å¬ ===
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    // === æ ¸å¿ƒé€»è¾‘ ===
    async function handleFile(file) {
        showStatus('æ­£åœ¨è¯»å–å¹¶è®¡ç®—...', 'normal');
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                processData(jsonData);
            } catch (err) {
                console.error(err);
                showStatus(`æ–‡ä»¶è¯»å–å¤±è´¥: ${err.message}`, 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function processData(rows) {
        if (!rows || rows.length === 0) {
            showStatus('é”™è¯¯ï¼šæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼æ— æ³•è§£æ', 'error');
            return;
        }

        // 1. æ£€æŸ¥å¿…è¦åˆ—
        const requiredCols = ['æ‰€å±å·¥ç‚¹', 'ç»åº¦', 'çº¬åº¦', 'è®¾å¤‡ç¼–ç '];
        const headers = Object.keys(rows[0]);
        const missing = requiredCols.filter(col => !headers.includes(col));

        if (missing.length > 0) {
            showStatus(`é”™è¯¯ï¼šç¼ºå°‘å¿…è¦åˆ— [${missing.join(', ')}]`, 'error');
            return;
        }

        // 2. æ•°æ®é¢„å¤„ç†ï¼ˆå¡«å……é»˜è®¤å€¼ï¼‰
        const cleanRows = rows.map(row => ({
            ...row,
            'è®¾å¤‡åç§°': row['è®¾å¤‡åç§°'] || String(row['è®¾å¤‡ç¼–ç ']),
            'æ‰€å±é¡¹ç›®': row['æ‰€å±é¡¹ç›®'] || 'é»˜è®¤é¡¹ç›®',
            'ç»åº¦': parseFloat(row['ç»åº¦']),
            'çº¬åº¦': parseFloat(row['çº¬åº¦'])
        })).filter(r => !isNaN(r['ç»åº¦']) && !isNaN(r['çº¬åº¦'])); // è¿‡æ»¤æ— æ•ˆåæ ‡

        // 3. åˆ†ç»„ (GroupBy Project + Site)
        const groups = {};
        cleanRows.forEach(row => {
            const key = `${row['æ‰€å±é¡¹ç›®']}###${row['æ‰€å±å·¥ç‚¹']}`;
            if (!groups[key]) groups[key] = [];
            groups[key].push(row);
        });

        // 4. å¯¹æ¯ä¸ªåˆ†ç»„è¿›è¡Œåˆ†æ
        const results = [];
        let outlierCount = 0;

        for (const key in groups) {
            const groupData = groups[key];
            const [project, site] = key.split('###');
            
            const analysis = analyzeGroup(groupData);
            
            if (analysis['å¼‚å¸¸è®¾å¤‡æ˜ç»†(>1km)'] !== 'æ— ') outlierCount++;

            results.push({
                'æ‰€å±é¡¹ç›®': project,
                'æ‰€å±å·¥ç‚¹': site,
                ...analysis
            });
        }

        globalProcessedData = results;
        renderTable(results);
        
        const msg = `è®¡ç®—å®Œæˆï¼å…±å¤„ç† ${results.length} ä¸ªå·¥ç‚¹ã€‚${outlierCount > 0 ? `å‘ç° ${outlierCount} ä¸ªå·¥ç‚¹å­˜åœ¨ä¸¥é‡åç§»ã€‚` : 'æ•°æ®è´¨é‡è‰¯å¥½ã€‚'}`;
        showStatus(msg, outlierCount > 0 ? 'error' : 'success'); // ç”¨ error æ ·å¼é†’ç›®æç¤ºå¼‚å¸¸
        document.getElementById('resultArea').style.display = 'block';
    }

    // === å•ä¸ªå·¥ç‚¹åˆ†æé€»è¾‘ (Pythoné€»è¾‘å¤åˆ») ===
    function analyzeGroup(group) {
        const count = group.length;
        const lons = group.map(r => r['ç»åº¦']);
        const lats = group.map(r => r['çº¬åº¦']);

        // 1. ç»Ÿè®¡å€¼
        const meanLon = mean(lons);
        const meanLat = mean(lats);
        const medianLon = median(lons);
        const medianLat = median(lats);

        // 2. å¯†åº¦åŠ æƒä¸­å¿ƒ (ç”¨åè·ç¦»åŠ æƒæ¨¡æ‹Ÿ KDE)
        // é€»è¾‘ï¼šè·ç¦»ä¸­ä½æ•°è¶Šè¿‘çš„ç‚¹ï¼Œæƒé‡è¶Šå¤§
        let densityLon = medianLon, densityLat = medianLat;
        if (count >= 3) {
            try {
                const weights = group.map(r => {
                    const d = haversine(medianLat, medianLon, r['çº¬åº¦'], r['ç»åº¦']);
                    return 1 / (d + 1); // +1 é˜²æ­¢é™¤ä»¥0
                });
                const sumW = sum(weights);
                densityLon = sum(group.map((r, i) => r['ç»åº¦'] * weights[i])) / sumW;
                densityLat = sum(group.map((r, i) => r['çº¬åº¦'] * weights[i])) / sumW;
            } catch (e) { console.warn("å¯†åº¦è®¡ç®—é™çº§"); }
        }

        // 3. åå·®åˆ†æ
        const distMeanMedian = haversine(meanLat, meanLon, medianLat, medianLon);

        // 4. è¯†åˆ«åç§»è®¾å¤‡
        const outlierInfos = [];
        group.forEach(row => {
            const dist = haversine(medianLat, medianLon, row['çº¬åº¦'], row['ç»åº¦']);
            if (dist > 1000) {
                outlierInfos.push(`${row['è®¾å¤‡åç§°']}(${row['è®¾å¤‡ç¼–ç ']})`);
            }
        });
        const outlierStr = outlierInfos.length > 0 ? outlierInfos.join("ã€") : "æ— ";

        // 5. å¤‡æ³¨ç”Ÿæˆ
        const remarks = [];
        let suggested = "ä¸­ä½æ•°";

        if (outlierInfos.length > 0) {
            remarks.push(`å‘ç°${outlierInfos.length}ä¸ªè®¾å¤‡åç§»è¶…1km`);
            remarks.push("å»ºè®®æ£€æŸ¥å¼‚å¸¸åˆ—è¡¨");
        }

        if (distMeanMedian > 500) {
            remarks.push(`å¹³å‡å€¼è¢«æ‹‰å${Math.round(distMeanMedian)}ç±³`);
            if (!remarks.includes("å»ºè®®æ£€æŸ¥å¼‚å¸¸åˆ—è¡¨")) remarks.push("å»ºè®®é‡‡ç”¨ä¸­ä½æ•°");
        } else if (distMeanMedian <= 100 && outlierInfos.length === 0) {
            remarks.push("æ•°æ®è´¨é‡è‰¯å¥½");
            suggested = "å¹³å‡å€¼";
        }

        return {
            'è®¾å¤‡æ•°é‡': count,
            'å·¥ç‚¹ç»åº¦_ä¸­ä½æ•°': medianLon,
            'å·¥ç‚¹çº¬åº¦_ä¸­ä½æ•°': medianLat,
            'å·¥ç‚¹ç»åº¦_å¹³å‡å€¼': meanLon,
            'å·¥ç‚¹çº¬åº¦_å¹³å‡å€¼': meanLat,
            'å·¥ç‚¹ç»åº¦_å¯†åº¦åŠ æƒ': densityLon,
            'å·¥ç‚¹çº¬åº¦_å¯†åº¦åŠ æƒ': densityLat,
            'ä¸­å¿ƒåå·®(ç±³)': parseFloat(distMeanMedian.toFixed(2)),
            'æ¨èåæ ‡ç±»å‹': suggested,
            'åˆ†æå¤‡æ³¨': remarks.join("; "),
            'å¼‚å¸¸è®¾å¤‡æ˜ç»†(>1km)': outlierStr
        };
    }

    // === æ•°å­¦å·¥å…·å‡½æ•° ===
    function toRad(Value) { return Value * Math.PI / 180; }

    function haversine(lat1, lon1, lat2, lon2) {
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    function mean(arr) { return arr.reduce((a, b) => a + b, 0) / arr.length; }

    function sum(arr) { return arr.reduce((a, b) => a + b, 0); }

    function median(arr) {
        const sorted = [...arr].sort((a, b) => a - b);
        const mid = Math.floor(sorted.length / 2);
        return sorted.length % 2 !== 0 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
    }

    // === UI æ¸²æŸ“ä¸å¯¼å‡º ===
    function renderTable(data) {
        const tableHead = document.querySelector('#previewTable thead');
        const tableBody = document.querySelector('#previewTable tbody');
        
        // ç”Ÿæˆè¡¨å¤´
        const columns = Object.keys(data[0]);
        tableHead.innerHTML = `<tr>${columns.map(c => `<th>${c}</th>`).join('')}</tr>`;

        // ç”Ÿæˆå†…å®¹ (åªæ˜¾ç¤ºå‰20æ¡é¢„è§ˆ)
        const previewData = data.slice(0, 20);
        tableBody.innerHTML = previewData.map(row => {
            const isOutlier = row['å¼‚å¸¸è®¾å¤‡æ˜ç»†(>1km)'] !== 'æ— ';
            return `<tr class="${isOutlier ? 'outlier-row' : ''}">
                ${columns.map(col => `<td>${formatVal(row[col])}</td>`).join('')}
            </tr>`;
        }).join('');
        
        if(data.length > 20) {
            tableBody.innerHTML += `<tr><td colspan="${columns.length}" style="text-align:center; color:#999;">... è¿˜æœ‰ ${data.length - 20} æ¡æ•°æ®ï¼Œè¯·ä¸‹è½½æŸ¥çœ‹å®Œæ•´ç‰ˆ ...</td></tr>`;
        }
    }

    function formatVal(val) {
        if (typeof val === 'number') {
            // ç»çº¬åº¦ä¿ç•™6ä½ï¼Œå…¶ä»–ä¿ç•™2ä½
            return val.toString().includes('.') ? (val > 1000 ? val.toFixed(2) : parseFloat(val.toFixed(8))) : val;
        }
        return val;
    }

    function showStatus(msg, type) {
        const box = document.getElementById('statusBox');
        box.style.display = 'block';
        box.textContent = msg;
        box.className = 'status-box ' + (type === 'error' ? 'status-error' : 'status-success');
    }

    function exportToExcel() {
        if (!globalProcessedData.length) return;
        
        const ws = XLSX.utils.json_to_sheet(globalProcessedData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å·¥ç‚¹åæ ‡è®¡ç®—");
        
        const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,"");
        XLSX.writeFile(wb, `å·¥ç‚¹åæ ‡è®¡ç®—_å«é¡¹ç›®ä¿¡æ¯_${dateStr}.xlsx`);
    }
</script>

</body>
</html>